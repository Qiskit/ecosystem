name: Project check workflow

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'Repository URL'
        required: true
      tier:
        description: 'Tier of project'
        required: false
        default: "COMMUNITY"
      issue_id:
        description: 'Id of issue to put comments in'
        required: true
      branch_name:
        description: 'Branch name to push changes'
        required: true

jobs:
  project_check_job:
    runs-on: ubuntu-latest
    steps:
    - name: Setup variables
      id: vars
      run: |
        echo "Running check for ${{ github.event.inputs.repo_url }}..."
        echo "Will be commenting in ${{ github.event.inputs.issue_id }}..."
        echo "Will push changes to ${{ github.event.inputs.branch_name }}..."
    - uses: actions/checkout@v2
      with:
        ref: ${{ github.event.inputs.branch_name }}
    - name: Set up Python 3.9
      uses: actions/setup-python@v2
      with:
          python-version: '3.9'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: Stable tests
      uses: ./.github/actions/run-tests
      with:
        repo_url: ${{ github.event.inputs.repo_url }}
        check_type: "test_stable"
        tox_env: "py39"
        tier: ${{ github.event.inputs.tier }}

    - name: Dev tests
      uses: ./.github/actions/run-tests
      with:
        repo_url: ${{ github.event.inputs.repo_url }}
        check_type: "test_dev"
        tox_env: "py39"
        tier: ${{ github.event.inputs.tier }}

    - name: Styles check
      uses: ./.github/actions/run-tests
      with:
        repo_url: ${{ github.event.inputs.repo_url }}
        check_type: "lint"
        tox_env: "py39"
        tier: ${{ github.event.inputs.tier }}

    - name: Commit changes
      run: |
        git pull --rebase --autostash
        git add ecosystem/resources/members.json
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git commit -m "Tests for ${{ github.event.inputs.repo_url }}"
        git push
