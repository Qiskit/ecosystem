name: Badge update workflow

on:
  #  Payload:
  #  "client_payload": {
  #    "branch_name": "weekly-checks-1", # 'Branch name to push changes'
  #    "issue_id": 49, # 'Id of issue to put comments in'
  #    "repo_name": "demo-implementation", # 'Repository name'
  #    "tests": "True / False' # 'Tests check'
  #  }
  repository_dispatch:
    types: [ badge_project ]

jobs:
  project_check_job:
    runs-on: ubuntu-latest
    steps:
    - name: Setup variables
      id: vars
      run: |
        echo "Generate badge for ${{ github.event.client_payload.repo_name }}..."
        echo "Will be commenting in ${{ github.event.client_payload.issue_id }}..."
        echo "Will push changes to ${{ github.event.client_payload.branch_name }}..."
    - uses: actions/checkout@v2
      with:
        ref: ${{ github.event.client_payload.branch_name }}

    - name: Generate badge
      id: gen_badge
      uses: ./.github/actions/update-badges
      with:
        repo_name: ${{ github.event.client_payload.repo_name }}
        status: ${{ github.event.client_payload.tests }}
        
    - name: Commit changes
      run: |
        git pull --rebase --autostash
        git add badges/${{ github.event.client_payload.repo_name }}.svg
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git commit -m "Update badge for for ${{ github.event.client_payload.repo_name }}" --allow-empty
        git push
        
    - name: Create comment
      uses: peter-evans/create-or-update-comment@v1
      with:
        repository: "qiskit-community/ecosystem"
        issue-number: ${{ github.event.client_payload.issue_id }}
        body: |
          Update badge for ${{ github.event.client_payload.repo_name }}
